---
title: "Chad's 2024 MLB Report"
output: github_document
knit: (function(input, ...) { rmarkdown::render(input, output_file = "README.md", envir = globalenv()) })
---

*Interested in the underlying code that builds this report?* Check it out on GitHub: [mlb24](https://github.com/chadallison/mlb24){target="_blank"}

___

### Contents

- [Team Standings]
- [Team NPR]
- [Total NPR Rankings]
- [Offensive NPR Rankings]
- [Defensive NPR Rankings]
- [Scorigami]
- [Yesterday's Largest Victories]
- [Team Volatility]
- [Runs Scored per Game]
- [One-Run Games]
- [NPR and Win Percentage]
- [Best Records in Last Ten Games]
- [Early Leads]
- [First Score Dependence]
- [Home Field Advantage]
- [Winning and Losing Streaks]
- [Seven Game Windows]
- [Team Margins in Seven Game Windows]
- [Team Series Results]
- [Records vs. Above/Below .500 Teams]
- [Pythagorean Wins]
- [Season Long NPR Trends]
- [Season Long Pythagorean Trends]
- [Runs Scored and Allowed Streaks]
- [Team NPR Trends in Past Ten Games]
- [First Inning Score Rates]
- [One Run vs. Multi Run Games]

___

```{r fold_code, include = F}
knitr::knit_hooks$set(source = function(x, options) {
    hook.r = function(x, options) {
      fence = "```"
      language = tolower(options$engine)
      if (language == "node") language = "javascript"
      if (!options$highlight) language = "text"
      if (!is.null(options$fold_code)) {
        paste0("\n\n", "<details><summary>View Code</summary>\n", fence, language,
               "\n", x, fence, "\n\n", "</details>\n")
      } else paste0('\n\n', fence, language, '\n', x, fence,  '\n\n')
    }
    x = knitr:::hilight_source(x, "markdown", options)
    hook.r(paste(c(x, ""), collapse = "\n"), options)
})
```

```{r message = F, warning = F, include = F, fold_code = T}
library(tidyverse)
library(tvthemes)
library(janitor)
library(glue)
library(baseballr)

theme_custom = theme_avatar() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 9, vjust = 2.5, face = "italic"),
        plot.caption = element_text(face = "italic"),
        panel.grid.major = element_line(linewidth = 0.5, colour = "#DFDAD1"),
        panel.grid.minor = element_line(linewidth = 0.5, colour = "#DFDAD1"))

theme_set(theme_custom)
```

```{r message = F, warning = F, include = F}
end_games = mlb_schedule(season = 2024, level_ids = "1") |>
  filter(series_description == "Regular Season" & status_detailed_state == "Final") |>
  select(date, game_pk, away_score = teams_away_score, away_team = teams_away_team_name,
         home_team = teams_home_team_name, home_score = teams_home_score) |>
  filter(!is.na(away_score) & !is.na(home_score)) |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score))

# writing and reading prevents baseballr message
write_csv(end_games, "data/end_games.csv")
end_games = read_csv("data/end_games.csv", show_col_types = F)
```

```{r include = F}
all_teams = sort(unique(c(end_games$home_team, end_games$away_team)))

team_abbrevs = c(
  "ARI", "ATL", "BAL", "BOS", "CHC", "CWS", "CIN", "CLE", "COL", "DET",
  "HOU", "KC", "LAA", "LAD", "MIA", "MIL", "MIN", "NYM", "NYY", "OAK",
  "PHI", "PIT", "SD", "SF", "SEA", "STL", "TB", "TEX", "TOR", "WAS"
)

team_hex = c(
  "#A71930", "#CE1141", "#DF4601", "#BD3039", "#0E3386", "#27251F",
  "#C6011F", "#00385D", "#333366", "#0C2340", "#002D62", "#004687",
  "#BA0021", "#005A9C", "#00A3E0", "#12284B", "#002B5C", "#FF5910",
  "#0C2340", "#003831", "#E81828", "#FDB827", "#2F241D" ,"#FD5A1E",
  "#005C5C", "#C41E3A", "#8FBCE6", "#003278", "#134A8E" ,"#FFB7C5"
)

divisions = c(
  "NL West", "NL East", "AL East", "AL East",
  "NL Central", "AL Central", "NL Central", "AL Central",
  "NL West", "AL Central", "AL West", "AL Central",
  "AL West", "NL West", "NL East", "NL Central",
  "AL Central", "NL East", "AL East", "AL West",
  "NL East", "NL Central", "NL West", "NL West",
  "AL West", "NL Central", "AL East", "AL West",
  "AL East", "NL East"
)

team_divisons = data.frame(team = all_teams, division = divisions) |>
  mutate(division = factor(division, levels = c("AL West", "AL Central", "AL East",
                                                "NL West", "NL Central", "NL East")))

teams_info = data.frame(team = all_teams, abb = team_abbrevs, hex = team_hex)

better_date = function(dt) {
  return(paste0(month(dt, label = T, abbr = F), " ", day(dt)))
}
```

### Team Standings

```{r echo = F}
team_records = end_games |>
  count(win_team) |>
  rename(team = win_team, wins = n) |>
  full_join(end_games |>
  count(lose_team) |>
  rename(team = lose_team, losses = n), by = "team") |>
  mutate(wins = coalesce(wins, 0),
         losses = coalesce(losses, 0),
         pct = round(wins / (wins + losses) * 100, 1),
         record = paste0(wins, "-", losses)) |>
  arrange(desc(pct), desc(wins), team)

team_records |>
  ggplot(aes(reorder(team, pct), pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.2) +
  coord_flip(ylim = c(0, max(team_records$pct) * 1.05)) +
  scale_fill_manual(values = team_hex) +
  labs(x = NULL, y = NULL, title = "2024 MLB Standings") +
  theme(axis.text.x = element_blank())
```

___

```{r include = F}
get_team_games_played = function(team) {
  return(end_games |>
    filter(home_team == team | away_team == team) |>
    nrow())
}

get_team_runs_scored = function(team) {
  home = end_games |> filter(home_team == team) |> pull(home_score)
  away = end_games |> filter(away_team == team) |> pull(away_score)
  return(sum(c(home, away)))
}

get_team_runs_allowed = function(team) {
  home = end_games |> filter(home_team == team) |> pull(away_score)
  away = end_games |> filter(away_team == team) |> pull(home_score)
  return(sum(c(home, away)))
}

team_rspg = data.frame(team = all_teams) |>
  mutate(games_played = sapply(team, get_team_games_played),
         runs_scored = sapply(team, get_team_runs_scored),
         runs_allowed = sapply(team, get_team_runs_allowed),
         runs_scored_per_game = round(runs_scored / games_played, 2),
         runs_allowed_per_game = round(runs_allowed / games_played, 2),
         run_diff = runs_scored - runs_allowed,
         run_diff_per_game = round(run_diff / games_played, 2)) |>
  arrange(desc(run_diff_per_game))
```

### Team NPR

```{r echo = F}
team_rpg = data.frame(team = all_teams) |>
  mutate(games_played = sapply(team, get_team_games_played),
         runs_scored = sapply(team, get_team_runs_scored),
         runs_allowed = sapply(team, get_team_runs_allowed),
         runs_scored_per_game = round(runs_scored / games_played, 2),
         runs_allowed_per_game = round(runs_allowed / games_played, 2),
         run_diff = runs_scored - runs_allowed) |>
  select(team, rspg = runs_scored_per_game, rapg = runs_allowed_per_game)

end_npr = end_games |>
  inner_join(team_rpg, by = c("home_team" = "team")) |>
  rename(home_rspg = rspg, home_rapg = rapg) |>
  inner_join(team_rpg, by = c("away_team" = "team")) |>
  rename(away_rspg = rspg, away_rapg = rapg) |>
  mutate(home_exp = round((home_rspg + away_rapg) / 2, 2),
         away_exp = round((away_rspg + home_rapg) / 2, 2),
         home_off_npr = home_score - home_exp,
         home_def_npr = away_exp - away_score,
         away_off_npr = away_score - away_exp,
         away_def_npr = home_exp - home_score)

get_team_off_npr = function(team) {
  home = end_npr |> filter(home_team == team) |> pull(home_off_npr)
  away = end_npr |> filter(away_team == team) |> pull(away_off_npr)
  return(round(mean(c(home, away)), 2))
}

get_team_def_npr = function(team) {
  home = end_npr |> filter(home_team == team) |> pull(home_def_npr)
  away = end_npr |> filter(away_team == team) |> pull(away_def_npr)
  return(round(mean(c(home, away)), 2))
}

team_npr = data.frame(team = all_teams) |>
  mutate(off_npr = sapply(team, get_team_off_npr),
         def_npr = sapply(team, get_team_def_npr),
         total_npr = off_npr + def_npr) |>
  arrange(desc(total_npr))

x_lim = ceiling(max(abs(c(min(team_npr$off_npr), max(team_npr$off_npr)))))
y_lim = ceiling(max(abs(c(min(team_npr$def_npr), max(team_npr$def_npr)))))

team_npr |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(off_npr, def_npr)) +
  geom_point(aes(col = team), size = 4, shape = "square", show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  geom_hline(yintercept = 0, col = "black", linetype = "dashed", alpha = 0.25) +
  geom_vline(xintercept = 0, col = "black", linetype = "dashed", alpha = 0.25) +
  scale_color_manual(values = teams_info$hex) +
  scale_x_continuous(breaks = seq(-x_lim, x_lim, by = 0.25)) +
  scale_y_continuous(breaks = seq(-y_lim, y_lim, by = 0.25)) +
  labs(x = "Offensive NPR", y = "Defensive NPR",
       title = "Scatterplot of Offensive/Defensive NPR",
       subtitle = "NPR = Naive Performance Rating, an evaluation of performance above/below expected")
```

**What is NPR?**

NPR, Naive Performance Rating, is a metric I devised as a measure of team performance above/below expected. The logic behind it is this: I calculate each team's expected runs scored in each game by taking the average of their runs scored per game and their opponent's runs allowed per game. I then compare this expected value to the actual value of runs scored or allowed to calculate each team's offensive and defensive NPR for each game. Here is an example.

Suppose the Cubs are playing the Cardinals. Let's say the Cubs, on average, score 4.5 runs per game and allow 3.25 runs per game. And let's say the Cardinals score 3.75 runs per game and allow 2.75 runs per game. We calculate the Cubs' expected run value as the average of their runs scored per game and the Cardinals' runs allowed per game, so (4.5 + 2.75) / 2 = 3.63. We would calculate the Cardinals' expected run value the same way, so (3.75 + 3.25) / 2 = 3.5. We now have the Cubs' expected run value as 3.63 and the Cardinals' expected run value as 3.5.

Suppose that the final score of the game is a Cubs victory, 5-3. We would calculate the Cubs' offensive NPR as their actual score minus their expected score: 5 - 3.63 = 1.37. We would calculate their defensive NPR as the Cardinals' expected score minus their actual score: 3.5 - 3 = 0.5 (we do it in this order so positive values are good). For the Cardinals, their offensive NPR is their actual score minus their expected score, 3 - 3.5 = -0.5, and their defensive NPR is the Cubs' expected score minus their actual score, 3.63 - 5 = -1.37. Notice how these numbers are opposite each other. So each team will have an offensive and defensive NPR for each game, which are aggregated in the plot below.

Of course, there are so many other factors that would play into a team's true expected value, such as any injuries, starting pitchers, weather, and more. That is why I have named it Naive Performance Rating, because it assumes matchup metrics are independent of each other and does not take external factors into account. Which, of course, will lead to flaws in the metric, but is done for the sake of simplicity and interpretability.

___

### Total NPR Rankings

```{r echo = F}
x_lim = ceiling(abs(max(team_npr$total_npr)))
y_lim = ceiling(abs(min(team_npr$total_npr)))

team_npr |>
  inner_join(teams_info, by = "team") |>
  mutate(pos_lab = ifelse(total_npr >= 0, total_npr, ""),
         neg_lab = ifelse(total_npr < 0, total_npr, "")) |>
  ggplot(aes(reorder(team, total_npr), total_npr)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 3, hjust = -0.1) +
  geom_text(aes(label = neg_lab), size = 3, hjust = 1.1) +
  coord_flip() +
  scale_fill_manual(values = team_hex) +
  scale_y_continuous(breaks = seq(-y_lim, x_lim, by = 0.25)) +
  labs(x = NULL, y = "Total NPR",
       title = "2024 Team NPR Rankings")
```

___

### Offensive NPR Rankings

```{r echo = F}
x_lim = ceiling(abs(max(team_npr$off_npr)))
y_lim = ceiling(abs(min(team_npr$off_npr)))

team_npr |>
  inner_join(teams_info, by = "team") |>
  mutate(pos_lab = ifelse(off_npr >= 0, off_npr, ""),
         neg_lab = ifelse(off_npr < 0, off_npr, "")) |>
  ggplot(aes(reorder(team, off_npr), off_npr)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 3, hjust = -0.1) +
  geom_text(aes(label = neg_lab), size = 3, hjust = 1.1) +
  coord_flip() +
  scale_fill_manual(values = team_hex) +
  scale_y_continuous(breaks = seq(-y_lim, x_lim, by = 0.25)) +
  labs(x = NULL, y = "Offensive NPR",
       title = "2024 Team Offensive NPR Rankings")
```

___

### Defensive NPR Rankings

```{r echo = F}
x_lim = ceiling(abs(max(team_npr$def_npr)))
y_lim = ceiling(abs(min(team_npr$def_npr)))

team_npr |>
  inner_join(teams_info, by = "team") |>
  mutate(pos_lab = ifelse(def_npr >= 0, def_npr, ""),
         neg_lab = ifelse(def_npr < 0, def_npr, "")) |>
  ggplot(aes(reorder(team, def_npr), def_npr)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 3, hjust = -0.1) +
  geom_text(aes(label = neg_lab), size = 3, hjust = 1.1) +
  coord_flip() +
  scale_fill_manual(values = team_hex) +
  scale_y_continuous(breaks = seq(-y_lim, x_lim, by = 0.25)) +
  labs(x = NULL, y = "Defensive NPR",
       title = "2024 Team Defensive NPR Rankings")
```

___

### Scorigami

```{r echo = F}
all_final_scores = end_games |>
  count(win_score, lose_score) |>
  transmute(final_score = paste0(win_score, "-", lose_score), n)

last_scorigami = end_games |>
  mutate(final_score = paste0(win_score, "-", lose_score)) |>
  inner_join(all_final_scores, by = "final_score") |>
  filter(n == 1) |>
  slice_max(date, n = 1, with_ties = F) |>
  mutate(desc = paste0(win_team, " def. ", lose_team, " ", final_score, " (", better_date(date), ")")) |>
  pull(desc)

end_games |>
  count(win_score, lose_score) |>
  arrange(desc(n)) |>
  ggplot(aes(win_score, lose_score)) +
  geom_point(size = 9, shape = "square", aes(col = n), show.legend = F) +
  geom_text(aes(label = n), size = 3.5) +
  labs(x = "Winning Score", y = "Losing Score",
       title = "2024 MLB Scorigami",
       subtitle = paste0("Last Scorigami: ", last_scorigami)) +
  scale_x_continuous(breaks = seq(0, max(end_games$win_score), by = 1)) +
  scale_y_continuous(breaks = seq(0, max(end_games$lose_score), by = 1)) +
  scale_color_gradient(low = "#ABC0A9", high = "#627C61")
```

___

```{r echo = F}
yesterday_blowouts = end_games |>
  filter(date == Sys.Date() - 1) |>
  mutate(mv = win_score - lose_score) |>
  slice_max(mv, n = 3, with_ties = F) |>
  mutate(desc = paste0(win_team, " def. ", lose_team, " ", win_score, "-", lose_score))
```

### Yesterday's Largest Victories

1. `r yesterday_blowouts$desc[1]`
2. `r yesterday_blowouts$desc[2]`
3. `r yesterday_blowouts$desc[3]`

___

### Team Volatility

```{r echo = F}
get_scored_sd = function(team) {
  home = end_games |> filter(home_team == team) |> pull(home_score)
  away = end_games |> filter(away_team == team) |> pull(away_score)
  return(round(sd(c(home, away)), 2))
}

get_allowed_sd = function(team) {
  home = end_games |> filter(home_team == team) |> pull(away_score)
  away = end_games |> filter(away_team == team) |> pull(home_score)
  return(round(sd(c(home, away)), 2))
}

runs_sd = data.frame(team = all_teams) |>
  mutate(scored_sd = sapply(team, get_scored_sd),
         allowed_sd = sapply(team, get_allowed_sd))

runs_sd |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(scored_sd, allowed_sd)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  scale_color_manual(values = team_hex) +
  geom_hline(yintercept = mean(runs_sd$allowed_sd), linetype = "dashed", alpha = 0.25) +
  geom_vline(xintercept = mean(runs_sd$scored_sd), linetype = "dashed", alpha = 0.25) +
  labs(x = "Runs Scored SD", y = "Runs Allowed SD",
       title = "Volatility Scatterplot") +
  scale_x_continuous(breaks = seq(0, 5, by = 0.25)) +
  scale_y_continuous(breaks = seq(0, 5, by = 0.25))

rx = runs_sd |>
  mutate(total_sd = scored_sd + allowed_sd) |>
  slice_max(total_sd, n = 3, with_ties = F) |>
  mutate(x = paste0(team, " (", total_sd, ")"))

sx = runs_sd |>
  mutate(total_sd = scored_sd + allowed_sd) |>
  slice_max(scored_sd, n = 3, with_ties = F) |>
  mutate(x = paste0(team, " (", scored_sd, ")"))

ax = runs_sd |>
  mutate(total_sd = scored_sd + allowed_sd) |>
  slice_max(allowed_sd, n = 3, with_ties = F) |>
  mutate(x = paste0(team, " (", allowed_sd, ")"))
```

##### Most Volatile Teams

1. `r rx$x[1]`
2. `r rx$x[2]`
3. `r rx$x[3]`

##### Most Volatile Offenses

1. `r sx$x[1]`
2. `r sx$x[2]`
3. `r sx$x[3]`

##### Most Volatile Defenses

1. `r ax$x[1]`
2. `r ax$x[2]`
3. `r ax$x[3]`

```{r echo = F}
end_margins = end_games |>
  mutate(margin = win_score - lose_score)

get_team_avg_margin = function(team) {
  x = end_margins |>
    filter(home_team == team | away_team == team) |>
    pull(margin)
  return(round(mean(x), 2))
}

team_margins = data.frame(team = all_teams) |>
  mutate(avg_margin = sapply(team, get_team_avg_margin))

margins_records = team_records |>
  select(team, pct) |>
  inner_join(team_margins, by = "team")
```

___

### Runs Scored per Game

```{r echo = F}
end_games |>
  mutate(runs = win_score + lose_score) |>
  count(runs) |>
  ggplot(aes(runs, n)) +
  geom_col(fill = "springgreen4") +
  labs(x = "Runs Scored", y = "Frequency",
       title = "Runs Scored per Game, 2024") +
  scale_x_continuous(breaks = seq(0, 100, by = 1)) +
  theme(axis.text.y = element_blank()) +
  geom_text(aes(label = n), size = 3, vjust = -0.5)
```

___

### One-Run Games

```{r echo = F}
onerun = end_games |>
  mutate(margin = win_score - lose_score,
         home_win = ifelse(home_team == win_team, 1, 0)) |>
  filter(margin == 1) |>
  count(win_team) |>
  set_names(c("team", "wins")) |>
  full_join(end_games |>
  mutate(margin = win_score - lose_score,
         home_win = ifelse(home_team == win_team, 1, 0)) |>
  filter(margin == 1) |>
  count(lose_team) |>
  set_names(c("team", "losses")), by = "team") |>
  inner_join(teams_info, by = "team") |>
  mutate(wins = coalesce(wins, 0),
         losses = coalesce(losses, 0),
         total = wins + losses,
         pct = round(wins / total * 100, 2))

onerun |>
  ggplot(aes(total, pct)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  scale_color_manual(values = team_hex) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3, segment.alpha = 0.25) +
  geom_vline(xintercept = mean(onerun$total), linetype = "dashed", alpha = 0.25) +
  geom_hline(yintercept = 50, linetype = "dashed", alpha = 0.25) +
  labs(x = "Number of One-Run Games Played", y = "Win Percentage in One-Run Games",
       title = "One-Run Game Performance") +
  scale_x_continuous(breaks = seq(0, 100, by = 1)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10))
```

___

### NPR and Win Percentage

```{r echo = F}
team_records |>
  distinct(team, pct) |>
  inner_join(team_npr |>
  distinct(team, total_npr), by = "team") |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(total_npr, pct)) +
  geom_point(aes(col = team), size = 4, shape = "square", show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  scale_color_manual(values = team_hex) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", se = F,
            col = "black", linetype = "dashed", alpha = 0.5) +
  labs(x = "Total NPR", y = "Win Percentage",
       title = "Scatterplot of NPR and Win Percentage",
       subtitle = "Teams above/below dashed line are worse/better than their record") +
  scale_x_continuous(breaks = seq(-5, 5, by = 0.25)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10)) +
  geom_hline(yintercept = 50, linetype = "dotted", col = "black", alpha = 0.2) +
  geom_vline(xintercept = 0, linetype = "dotted", col = "black", alpha = 0.2)
```

___

```{r echo = F}
get_team_last_10 = function(team) {
  games = end_games |> filter(home_team == team | away_team == team) |> slice_max(date, n = 10, with_ties = F)
  wins = games |> filter(win_team == team) |> nrow()
  losses = games |> filter(lose_team == team) |> nrow()
  return(paste0(wins, "-", losses))
}

last10 = data.frame(team = all_teams) |>
  mutate(last10 = sapply(team, get_team_last_10)) |>
  separate(last10, into = c("wins", "losses"), sep = "-", convert = T, remove = F) |>
  mutate(pct = wins / (wins + losses) * 100) |>
  arrange(desc(pct), team) |>
  head(10) |>
  mutate(x = paste0(team, " (", wins, "-", losses, ")"))
```

### Best Records in Last Ten Games

1. `r last10$x[1]`
2. `r last10$x[2]`
3. `r last10$x[3]`
4. `r last10$x[4]`
5. `r last10$x[5]`
6. `r last10$x[6]`
7. `r last10$x[7]`
8. `r last10$x[8]`
9. `r last10$x[9]`
10. `r last10$x[10]`

___

```{r echo = F}
get_game_first_score_team = function(pk) {
  x = mlb_pbp(pk) |>
    mutate(about.startTime = as_datetime(about.startTime)) |>
    filter(result.awayScore > 0 | result.homeScore > 0) |>
    slice_min(about.startTime, n = 1, with_ties = F) |>
    pull(batting_team) |>
    unlist()
  return(x[1])
}

# end_first_scores = end_games |>
#   mutate(first_scorer = sapply(game_pk, get_game_first_score_team))

end_first_scores = read_csv("data/first_scorers.csv", show_col_types = F)

new_scores = end_games |>
  filter(!game_pk %in% end_first_scores$game_pk)

if (nrow(new_scores) > 0) {
  new_first_scores = new_scores |>
    mutate(first_scorer = sapply(game_pk, get_game_first_score_team))
  
  end_first_scores = rbind(end_first_scores, new_first_scores)
}

write_csv(end_first_scores, "data/first_scorers.csv")
```

### Early Leads

```{r echo = F}
first_score_rates = end_first_scores |>
  count(first_scorer) |>
  arrange(desc(n)) |>
  rename(team = first_scorer, first_scores = n) |>
  inner_join(team_records |>
  transmute(team, gp = wins + losses, win_pct = pct), by = "team") |>
  mutate(first_score_rate = round(first_scores / gp * 100, 1))

get_team_win_pct_when_first_score = function(team) {
  data = end_first_scores |> filter(first_scorer == team)
  wins = data |> filter(win_team == team) |> nrow()
  losses = data |> filter(lose_team == team) |> nrow()
  return(round(wins / (wins + losses) * 100, 1))
}

get_team_win_pct_not_first_score = function(team) {
  data = end_first_scores |> filter((home_team == team | away_team == team) & first_scorer != team)
  wins = data |> filter(win_team == team) |> nrow()
  losses = data |> filter(lose_team == team) |> nrow()
  return(round(wins / (wins + losses) * 100, 1))
}

first_score_rates |>
  mutate(win_pct_on_first_score = sapply(team, get_team_win_pct_when_first_score)) |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(first_score_rate, win_pct_on_first_score)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  scale_color_manual(values = team_hex) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  geom_line(stat = "smooth", method = "lm", formula = y ~ x, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 50, linetype = "dotted", alpha = 0.25) +
  geom_hline(yintercept = 50, linetype = "dotted", alpha = 0.25) +
  labs(x = "First Score Rate", y = "Win Percentage When Scoring First",
       title = "Which teams capitalize on an early lead?") +
  scale_x_continuous(breaks = seq(0, 100, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 5))
```

___

### First Score Dependence

```{r echo = F}
fs_teams = first_score_rates |>
  mutate(win_pct_on_first_score = sapply(team, get_team_win_pct_when_first_score),
         win_pct_not_first_score = sapply(team, get_team_win_pct_not_first_score),
         diff = win_pct_on_first_score - win_pct_not_first_score) |>
  slice_max(diff, n = 3, with_ties = F) |>
  pull(team)

fs_diffs = first_score_rates |>
  mutate(win_pct_on_first_score = sapply(team, get_team_win_pct_when_first_score),
         win_pct_not_first_score = sapply(team, get_team_win_pct_not_first_score),
         diff = win_pct_on_first_score - win_pct_not_first_score) |>
  slice_max(diff, n = 3, with_ties = F) |>
  pull(diff)

plot_subtitle = paste0("Most dependent teams: ", fs_teams[1], " (", fs_diffs[1], "%), ", fs_teams[2], " (", fs_diffs[2], "%), ", fs_teams[3], " (", fs_diffs[3], "%)")

first_score_rates |>
  mutate(win_pct_on_first_score = sapply(team, get_team_win_pct_when_first_score),
         win_pct_not_first_score = sapply(team, get_team_win_pct_not_first_score),
         diff = win_pct_on_first_score - win_pct_not_first_score) |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(win_pct_on_first_score, win_pct_not_first_score)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  scale_color_manual(values = team_hex) +
  geom_line(stat = "smooth", method = "lm", formula = y ~ x, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 50, linetype = "dotted", alpha = 0.5) +
  geom_hline(yintercept = 50, linetype = "dotted", alpha = 0.5) +
  labs(x = "Win Percentage When Scoring First",
       y = "Win Percentage When Not Scoring First",
       title = "Win Percentages When Scoring First/Second",
       subtitle = plot_subtitle) +
  scale_x_continuous(breaks = seq(0, 100, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 5))
```

```{r echo = F, eval = F}
get_pct_on = function(team, dt) {
  games = end_games |> filter((home_team == team | away_team == team) & date <= dt)
  wins = games |> filter(win_team == team) |> nrow()
  ls = games |> filter(lose_team == team) |> nrow()
  pct = round(wins / (wins + ls) * 100, 1)
  return(pct)
}

get_record_on = function(team, dt) {
  games = end_games |> filter((home_team == team | away_team == team) & date <= dt)
  if (nrow(games) == 0) return("NO GAMES YET")
  wins = games |> filter(win_team == team) |> nrow()
  ls = games |> filter(lose_team == team) |> nrow()
  str = paste0(wins, "-", ls)
  return(str)
}

all_game_dates = sort(unique(end_games$date))

time_records = crossing(date = all_game_dates, team = all_teams) |>
  rowwise() |>
  mutate(win_pct = get_pct_on(team = team, dt = date),
         record = get_record_on(team = team, dt = date)) |>
  ungroup() |>
  filter(record != "NO GAMES YET")

time_records |>
  ggplot(aes(date, win_pct)) +
  geom_line(aes(col = team), linewidth = 1, show.legend = F) +
  scale_color_manual(values = team_hex) +
  scale_x_continuous(breaks = seq.Date(from = min(end_games$date), to = max(end_games$date), by = 7)) +
  labs(x = NULL, y = "Win Percentage",
       title = "Team Win Percentages over Time")
```

___

### Home Field Advantage

```{r echo = F}
get_home_win_pct = function(team) {
  return(end_games |>
    filter(home_team == team) |>
    mutate(home_win = ifelse(win_team == home_team, 1, 0)) |>
    summarise(pct = round(mean(home_win) * 100, 1)) |>
    pull(pct))
}

get_away_win_pct = function(team) {
  return(end_games |>
    filter(away_team == team) |>
    mutate(away_win = ifelse(win_team == away_team, 1, 0)) |>
    summarise(pct = round(mean(away_win) * 100, 1)) |>
    pull(pct))
}

home_away_pct = data.frame(team = all_teams) |>
  mutate(home_win_pct = sapply(team, get_home_win_pct),
         away_win_pct = sapply(team, get_away_win_pct),
         diff = home_win_pct - away_win_pct)

home_away_pct |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(home_win_pct, away_win_pct)) +
  geom_point(aes(col = team), size = 4, shape = "square", show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  scale_color_manual(values = team_hex) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 50, linetype = "dotted", alpha = 0.25) +
  geom_hline(yintercept = 50, linetype = "dotted", alpha = 0.25) +
  labs(x = "Home Win Percentage", y = "Away Win Percentage",
       title = "Home/Away Dependence",
       subtitle = "Teams below dashed line are better at home") +
  scale_x_continuous(breaks = seq(0, 100, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 5))
```

```{r echo = F}
home_dep = home_away_pct |>
  slice_max(diff, n = 3, with_ties = F) |>
  mutate(x = paste0(team, " (", home_win_pct, "% home / ", away_win_pct, "% away)")) |>
  pull(x)

away_dep = home_away_pct |>
  slice_min(diff, n = 3, with_ties = F) |>
  mutate(x = paste0(team, " (", home_win_pct, "% home / ", away_win_pct, "% away)")) |>
  pull(x)
```

##### Most Home-Dependent Teams

- `r home_dep[1]`
- `r home_dep[2]`
- `r home_dep[3]`

##### Better-on-the-Road Teams

- `r away_dep[1]`
- `r away_dep[2]`
- `r away_dep[3]`

___

```{r echo = F}
get_win_streak = function(team) {
  games = end_games |> filter(home_team == team | away_team == team) |> mutate(result = ifelse(win_team == team, "W", "L")) |> arrange(desc(date))
  ws = 0
  for (i in 1:nrow(games)) {
    if (games$result[i] == "W") {
      ws = ws + 1
    } else {
      return(ws)
    }
  }
}

get_lose_streak = function(team) {
  games = end_games |> filter(home_team == team | away_team == team) |> mutate(result = ifelse(win_team == team, "W", "L")) |> arrange(desc(date))
  ls = 0
  for (i in 1:nrow(games)) {
    if (games$result[i] == "L") {
      ls = ls + 1
    } else {
      return(ls)
    }
  }
}

win_lose_streaks = data.frame(team = all_teams) |>
  mutate(win_streak = sapply(team, get_win_streak),
         lose_streak = sapply(team, get_lose_streak),
         streak = ifelse(win_streak > lose_streak, paste0("W", win_streak), paste0("L", lose_streak)))

win_streaks = win_lose_streaks |>
  filter(win_streak > 1) |>
  mutate(x = paste0(team, " (", streak, ")")) |>
  arrange(desc(win_streak)) |>
  pull(x)

lose_streaks = win_lose_streaks |>
  filter(lose_streak > 1) |>
  mutate(x = paste0(team, " (", streak, ")")) |>
  arrange(desc(lose_streak)) |>
  pull(x)

win_streaks = paste(win_streaks, collapse = ", ")
lose_streaks = paste(lose_streaks, collapse = ", ")
```

### Winning and Losing Streaks

- **Winning Streaks**: `r win_streaks`
- **Losing Streaks**: `r lose_streaks`

<!-- ___ -->


<!-- ### Day of Week Results -->

<!-- ```{r echo = F} -->
<!-- days_of_week = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday") -->


<!-- ``` -->

<!-- ##### Winners -->

<!-- - -->

<!-- ##### Losers -->

<!-- - -->

___

### Seven Game Windows

```{r echo = F}
seven_seq = rep(1:24, each = 7)

get_seven_group_pct = function(team, group) {
  data = end_games |>
    filter(home_team == team | away_team == team) |>
    arrange(date)
  
  data = data |>
    mutate(seven_group = seven_seq[1:nrow(data)]) |>
    filter(seven_group == group)

  if (nrow(data) == 0) return(NA)
  wins = data |> filter(win_team == team) |> nrow()
  return(round(wins / nrow(data) * 100, 1))
}

max_gp = team_records |>
  transmute(gp = wins + losses) |>
  slice_max(gp, n = 1, with_ties = F) |>
  pull(gp)

upper_lim = ceiling(max_gp / 7)

team_sevens = crossing(team = all_teams, seven_group = 1:upper_lim) |>
  rowwise() |>
  mutate(pct = get_seven_group_pct(team = team, group = seven_group)) |>
  ungroup() |>
  filter(!is.na(pct))

sevens_wl = team_sevens |>
  mutate(wl = case_when(pct > 50 ~ "W",
                        pct < 50 ~ "L",
                        pct == 50 ~ "Incomplete"))

sevens_pcts = sevens_wl |>
  filter(wl == "W") |>
  count(team) |>
  rename(sev_wins = n) |>
  inner_join(sevens_wl |>
  filter(wl == "L") |>
  count(team) |>
  rename(sev_losses = n), by = "team") |>
  mutate(sev_pct = round(sev_wins / (sev_wins + sev_losses) * 100, 1)) |>
  inner_join(teams_info, by = "team") |>
  inner_join(team_records, by = "team") |>
  arrange(desc(sev_pct), desc(pct), team) |>
  pull(abb)

sevens_wl |>
  inner_join(teams_info, by = "team") |>
  mutate(abb = factor(abb, levels = sevens_pcts),
         wl = case_when(wl == "W" ~ "Series Win", wl == "L" ~ "Series Loss", wl == "Incomplete" ~ "Series Currently Tied"),
         wl = factor(wl, levels = c("Series Win", "Series Loss", "Series Currently Tied"))) |>
  ggplot(aes(seven_group, 1)) +
  geom_col(aes(fill = wl), position = "dodge") +
  facet_wrap(vars(abb)) +
  scale_fill_manual(values = c("#004D40", "#D81B60", "#FFC107")) +
  labs(x = NULL, y = NULL, fill = NULL,
       title = "What if the season was split into seven-game windows?") +
  theme(axis.text = element_blank())
```

___

### Team Margins in Seven Game Windows

```{r echo = F}
get_seven_window_margin = function(team, group) {
  data = end_games |> filter(home_team == team | away_team == team) |> arrange(date)
  data$seven_group = seven_seq[1:nrow(data)]
  data = data |> filter(seven_group == group)
  if (nrow(data) == 0) return(NA)
  
  margin = data |>
    mutate(team_score = ifelse(home_team == team, home_score, away_score),
           opp_score = ifelse(home_team == team, away_score, home_score),
           margin = team_score - opp_score) |>
    summarise(x = sum(margin)) |>
    pull(x)
  
  return(margin)
}

crossing(team = all_teams, seven_group = 1:upper_lim) |>
  rowwise() |>
  mutate(margin = get_seven_window_margin(team, seven_group)) |>
  ungroup() |>
  filter(!is.na(margin)) |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(seven_group, 1)) +
  geom_col(aes(fill = margin), show.legend = F) +
  facet_wrap(vars(abb), scale = "free") +
  theme(axis.text = element_blank()) +
  scale_fill_gradient(low = "indianred3", high = "springgreen4") +
  labs(x = NULL, y = NULL,
       title = "Team Margins in Seven-Game Windows")
```

___

### Team Series Results

```{r echo = F}
get_series_data = function(team, series) {
  x = end_games |>
    filter(home_team == team | away_team == team) |>
    arrange(date) |>
    mutate(my_team = ifelse(home_team == team, home_team, away_team),
           opp_team = ifelse(home_team == team, away_team, home_team))
  
  x$series_num = NA
  x$series_num[1] = 1
  
  for (i in 2:nrow(x)) {
    if (x$opp_team[i] == x$opp_team[i - 1]) {
      x$series_num[i] = x$series_num[i - 1]
    } else {
      x$series_num[i] = x$series_num[i - 1] + 1
    }
  }
  
  data = x |> filter(series_num == series)
  if (nrow(data) == 0) return(NA)
  wins = data |> filter(win_team == team) |> nrow()
  losses = data |> filter(lose_team == team) |> nrow()
  
  if (wins > losses) {
    return("Series Win")
  } else if (wins < losses) {
    return("Series Loss")
  } else {
    return("Series Tied or In Progress")
  }
  
  return(x)
}

upper_lim = ceiling(team_records |>
  transmute(gp = wins + losses) |>
  slice_max(gp, n = 1, with_ties = F) |>
  pull(gp) / 2)

team_series_results = crossing(team = all_teams, series = 1:upper_lim) |>
  rowwise() |>
  mutate(wl = get_series_data(team, series)) |>
  ungroup() |>
  filter(!is.na(wl))

team_series_results |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(series, 1)) +
  geom_col(aes(fill = wl), width = 0.75, position = "dodge") +
  facet_wrap(vars(abb), scales = "free") +
  scale_fill_manual(values = c("indianred3", "black", "springgreen4")) +
  theme(axis.text = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Team Series Results")
```

___

## Records vs. Above/Below .500 Teams

```{r echo = F}
end_pct = end_games |>
  inner_join(team_records |>
  distinct(team, pct), by = c("home_team" = "team")) |>
  rename(home_pct = pct) |>
  inner_join(team_records |>
  distinct(team, pct), by = c("away_team" = "team")) |>
  rename(away_pct = pct)

get_win_pct_above_500 = function(team) {
  data = end_pct |>
    filter(home_team == team | away_team == team) |>
    mutate(opp_pct = ifelse(home_team == team, away_pct, home_pct)) |>
    filter(opp_pct >= 50)
  
  games = nrow(data)
  wins = data |> filter(win_team == team) |> nrow()
  
  return(round(wins / games * 100, 1))
}

get_win_pct_below_500 = function(team) {
  data = end_pct |>
    filter(home_team == team | away_team == team) |>
    mutate(opp_pct = ifelse(home_team == team, away_pct, home_pct)) |>
    filter(opp_pct < 50)
  
  games = nrow(data)
  wins = data |> filter(win_team == team) |> nrow()
  
  return(round(wins / games * 100, 1))
}

above_below_500 = data.frame(team = all_teams) |>
  mutate(above_500_pct = sapply(team, get_win_pct_above_500),
         below_500_pct = sapply(team, get_win_pct_below_500))

above_below_500 |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(below_500_pct, above_500_pct)) +
  geom_point(aes(col = team), size = 4, shape = "square", show.legend = F) +
  # geom_hline(yintercept = 50, alpha = 0.05) +
  # geom_vline(xintercept = 50, alpha = 0.05) +
  geom_hline(yintercept = mean(above_below_500$above_500_pct), linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = mean(above_below_500$below_500_pct), linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_hex) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  labs(x = "Win Percentage vs. Below .500 Opponents",
       y = "Win Percentage vs. Above .500 Opponents",
       title = "Win Percentage vs. Above/Below .500 Opponents",
       subtitle = "Dashed lines represent league averages") +
  scale_x_continuous(breaks = seq(0, 100, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 5))
```

___

### Pythagorean Wins

```{r echo = F}
team_rpg |>
  mutate(py = round((rspg ^ 2) / (rspg ^ 2 + rapg ^ 2) * 100, 1)) |>
  inner_join(team_records, by = "team") |>
  distinct(team, pct, py) |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(py, pct)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  scale_color_manual(values = team_hex) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  labs(x = "Pythagorean Wins", y = "True Win Percentage",
       title = "Pythagorean Wins v. True Win Percentage",
       subtitle = "Teams above dashed line are better than they 'should' be") +
  scale_x_continuous(breaks = seq(0, 100, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 5))
```

___

### Season Long NPR Trends

```{r echo = F}
get_npr_on = function(team, dt) {
  return(end_npr |>
    filter((home_team == team | away_team == team) & date <= dt) |>
    mutate(team_npr = ifelse(home_team == team, home_off_npr + home_def_npr, away_off_npr + away_def_npr)) |>
    summarise(npr = sum(team_npr)) |>
    pull(npr))
}

all_szn_dates = seq.Date(from = min(end_games$date), to = Sys.Date(), by = 1)

npr_on_dates = crossing(team = all_teams, date = all_szn_dates) |>
  rowwise() |>
  mutate(npr_on_date = get_npr_on(team = team, dt = date)) |>
  ungroup()

npr_on_dates = npr_on_dates |>
  inner_join(teams_info, by = "team") |>
  inner_join(team_divisons, by = "team")

last_dates = npr_on_dates |>
  group_by(team) |>
  filter(date == max(date)) |>
  ungroup()

npr_on_dates |>
  ggplot(aes(date, npr_on_date)) +
  geom_line(aes(col = team), linewidth = 1.25, show.legend = F) +
  scale_color_manual(values = team_hex) +
  theme(axis.text = element_blank()) +
  facet_wrap(vars(division)) +
  labs(x = NULL, y = NULL, title = "Season-Long Team NPR Trends") +
  ggrepel::geom_text_repel(aes(label = abb), data = last_dates, segment.alpha = 0, nudge_x = 10, direction = "y", hjust = 0, size = 3, show.legend = F)
```

___

### Season Long Pythagorean Trends

```{r echo = F}
get_py_on = function(team, dt) {
  data = end_games |>
    filter((home_team == team | away_team == team) & date <= dt) |>
    mutate(team_score = ifelse(home_team == team, home_score, away_score),
           opp_score = ifelse(home_team == team, away_score, home_score))
  
  rs = sum(data$team_score)
  ra = sum(data$opp_score)
  py = round(rs ^ 2 / (rs ^ 2 + ra ^ 2) * 100, 1)
  return(py)
}

py_dates = crossing(team = all_teams, date = all_szn_dates) |>
  rowwise() |>
  mutate(py_on_date = get_py_on(team = team, dt = date)) |>
  ungroup() |>
  na.omit()

py_on_dates = py_dates |>
  inner_join(teams_info, by = "team") |>
  inner_join(team_divisons, by = "team")

label_positions = py_on_dates |>
  group_by(team) |>
  filter(date == max(date)) |>
  ungroup()

py_on_dates |>
  ggplot(aes(date, py_on_date)) +
  geom_line(aes(col = team), linewidth = 1.25, show.legend = F) +
  ggrepel::geom_text_repel(data = label_positions, aes(label = abb), size = 3, hjust = 1, nudge_x = 10, show.legend = F) +
  scale_color_manual(values = team_hex) +
  theme(axis.text = element_blank()) +
  facet_wrap(vars(division)) +
  labs(x = NULL, y = NULL,
       title = "Season-Long Pythagorean Winning Percentage",
       caption = "Pythagorean Wins = (Runs Scored ^ 2) / (Runs Scored ^ 2 + Runs Allowed ^ 2)")
```

___

```{r echo = F}
get_team_game_runs = function(team) {
  data = end_games |>
    filter(home_team == team | away_team == team) |>
    mutate(my_score = ifelse(home_team == team, home_score, away_score),
           other_score = ifelse(home_team == team, away_score, home_score)) |>
    distinct(date, my_score, other_score) |>
    arrange(desc(date)) |>
    pull(my_score)
  
  count = 0
  
  if (data[1] < 3) {
    return(0)
  } else {
    i = 1
    while (data[i] >= 3) {
      count = count + 1
      i = i + 1
    }
  }
  
  return(count)
}

x = data.frame(team = all_teams) |>
  mutate(run_streak = sapply(team, get_team_game_runs)) |>
  slice_max(run_streak, n = 5, with_ties = F) |>
  mutate(x = as.character(glue("{team} ({run_streak})"))) |>
  pull(x)
```

### Runs Scored and Allowed Streaks

##### Longest Streaks of Scoring Three or More Runs

- `r x[1]`
- `r x[2]`
- `r x[3]`
- `r x[4]`
- `r x[5]`

```{r echo = F}
get_team_game_runs_allowed = function(team) {
  data = end_games |>
    filter(home_team == team | away_team == team) |>
    mutate(my_score = ifelse(home_team == team, home_score, away_score),
           other_score = ifelse(home_team == team, away_score, home_score)) |>
    distinct(date, my_score, other_score) |>
    arrange(desc(date)) |>
    pull(other_score)
  
  count = 0
  
  if (data[1] >= 5) {
    return(0)
  } else {
    i = 1
    while (data[i] < 5) {
      count = count + 1
      i = i + 1
    }
  }
  
  return(count)
}

y = data.frame(team = all_teams) |>
  mutate(all = sapply(team, get_team_game_runs_allowed)) |>
  slice_max(all, n = 5, with_ties = F) |>
  mutate(y = as.character(glue("{team} ({all})"))) |>
  pull(y)
```

##### Longest Streaks of Allowing Fewer Than Five Runs

- `r y[1]`
- `r y[2]`
- `r y[3]`
- `r y[4]`
- `r y[5]`

___

### Team NPR Trends in Past Ten Games

```{r echo = F}
get_date_tenth_last_game = function(team) {
  date = end_games |>
    filter(home_team == team | away_team == team) |>
    slice_max(date, n = 10, with_ties = F) |>
    slice_min(date, n = 1, with_ties = F) |>
    pull(date)
  
  return(as.character(date))
}

teams_tenth_last = data.frame(team = all_teams) |>
  mutate(tenth_date = as_date(sapply(team, get_date_tenth_last_game)))

last_ten_npr_diff = teams_tenth_last |>
  rowwise() |>
  mutate(npr_past = get_npr_on(team = team, dt = tenth_date)) |>
  ungroup() |>
  inner_join(team_npr |>
  distinct(team, total_npr), by = "team") |>
  inner_join(team_records |>
  transmute(team, gp = wins + losses), by = "team") |>
  mutate(npr_past = round(npr_past / gp, 2),
         diff = total_npr - npr_past) |>
  distinct(team, npr_past, total_npr, diff)

last_ten_diffs = last_ten_npr_diff |> distinct(team, diff)

segment_data = last_ten_npr_diff |>
  distinct(team, npr_past, total_npr) |>
  inner_join(last_ten_diffs, by = "team") |>
  mutate(diff = round(diff, 2),
         team = as.character(glue("{team} ({diff})")))

segment_data |>
  ggplot(aes(x = reorder(team, diff), xend = reorder(team, diff), y = npr_past, yend = total_npr, col = diff)) +
  geom_segment(linewidth = 3, show.legend = F) +
  coord_flip() +
  labs(x = NULL, y = "Change in NPR",
       title = "Team NPR Trends in Past Ten Games") +
  scale_y_continuous(breaks = seq(-5, 5, by = 0.1)) +
  scale_color_gradient(low = "indianred3", high = "springgreen4")
```

___

### First Inning Score Rates

```{r echo = F}
get_pk_first_inning_scores = function(pk) {
  return(mlb_pbp(game_pk = pk) |>
    filter(about.inning == 1) |>
    group_by(game_pk, home_team, away_team) |>
    summarise(home_flg = ifelse(max(result.homeScore) > 0, 1, 0),
              away_flg = ifelse(max(result.awayScore) > 0, 1, 0),
              .groups = "drop"))
}

first_inning_scores = read_csv("data/first_inning_scores.csv", show_col_types = F)
already_done_pks = first_inning_scores$game_pk
to_do_pks = end_games |> filter(!game_pk %in% already_done_pks) |> pull(game_pk)
new_pks = data.frame()

for (pk in to_do_pks) {
  new_pks = bind_rows(new_pks, get_pk_first_inning_scores(pk))
}

first_inning_scores = bind_rows(first_inning_scores, new_pks)
write_csv(first_inning_scores, "data/first_inning_scores.csv")

get_team_fi_score_rate = function(team) {
  home = first_inning_scores |> filter(home_team == team) |> pull(home_flg)
  away = first_inning_scores |> filter(away_team == team) |> pull(away_flg)
  return(round(mean(c(home, away)) * 100, 1))
}

get_team_fi_allow_rate = function(team) {
  home = first_inning_scores |> filter(home_team == team) |> pull(away_flg)
  away = first_inning_scores |> filter(away_team == team) |> pull(home_flg)
  return(round(mean(c(home, away)) * 100, 1))
}

fi_rates = data.frame(team = all_teams) |>
  mutate(fi_score_rate = sapply(team, get_team_fi_score_rate),
         fi_allow_rate = sapply(team, get_team_fi_allow_rate))

fi_rates |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(fi_score_rate, fi_allow_rate)) +
  geom_point(aes(col = team), shape = "square", size = 4, show.legend = F) +
  scale_color_manual(values = team_hex) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  geom_vline(xintercept = mean(fi_rates$fi_score_rate), linetype = "dashed", alpha = 0.25) +
  geom_hline(yintercept = mean(fi_rates$fi_allow_rate), linetype = "dashed", alpha = 0.25) +
  labs(x = "First Inning Score Rate", y = "First Inning Run Allowance Rate",
       title = "First Inning Run Score/Allowance Rates")
```

___

### One Run vs. Multi Run Games

```{r echo = F}
get_team_one_run_win_pct = function(team) {
  games = end_margins |> filter(margin == 1 & (home_team == team | away_team == team))
  total = nrow(games)
  wins = games |> filter(win_team == team) |> nrow()
  return(round(wins / total * 100, 2))
}

get_team_multi_run_win_pct = function(team) {
  games = end_margins |> filter(margin > 1 & (home_team == team | away_team == team))
  total = nrow(games)
  wins = games |> filter(win_team == team) |> nrow()
  return(round(wins / total * 100, 2))
}

data.frame(team = all_teams) |>
  mutate(or_pct = sapply(team, get_team_one_run_win_pct),
         mr_pct = sapply(team, get_team_multi_run_win_pct)) |>
  inner_join(teams_info, by = "team") |>
  ggplot(aes(or_pct, mr_pct)) +
  geom_point(aes(col = team), size = 4, shape = "square", show.legend = F) +
  scale_color_manual(values = team_hex) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3) +
  geom_vline(xintercept = 50, linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = 50, linetype = "dashed", alpha = 0.5) +
  labs(x = "Win Percentage in One-Run Games",
       y = "Win Percentage in Multi-Run Games",
       title = "One-Run vs. Multi-Run Games") +
  scale_x_continuous(breaks = seq(0, 100, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 5))
```

___











